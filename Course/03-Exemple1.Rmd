# Exemple 1

Lien entre l'updrs on et la durée de la maladie, la mutation, sexe et l'âge at onset.

UPDRS ~ Disease duration * Mutation + Sexe + Age at onset

```{r}
# Data simulation
# libraries
library(ggsci)
library(rstatix)

# Simulation des données
## Seed
set.seed(123456)
## Variables indépendantes
Mutation <- rep(factor(c("m/m", "m/f", "f/f", "m/s", "f/s", "s/s"), levels = c("m/m", "m/f", "f/f", "m/s", "f/s", "s/s")), each = 100)
Age_at_onset <- round(unlist(lapply(c(36, 34, 33, 30, 29, 27), function(x) rnorm(100, mean = x, sd = 5))))
Disease_duration <- round(runif(n = 600, min = 0, max = 40))
# Disease_duration <- 40 - 1/2 * Age_at_onset + rnorm(600, 0, sd = 8.5)
Disease_duration <- round(abs(Disease_duration))
Sex <- sample(factor(c("Male", "Female")), 600, replace = TRUE)
Age <- Disease_duration + Age_at_onset

## Coefficient
intercept <- 10
coeff_duration_A <- 0.5
coeff_duration_B <- 0.75
coeff_Age_at_onset_at_onset <- 0.25

## Calcul de l'UPDRS
UPDRS <- intercept + 
  coeff_duration_A  *  Disease_duration * (Mutation %in% c("m/m", "m/f", "f/f")) +
  coeff_duration_B  *  Disease_duration * (Mutation %in% c("m/s", "f/s", "s/s")) +
  coeff_Age_at_onset_at_onset * Age +
  rnorm(600, mean = 0, sd = 5)

## Data
data <- data.frame(Mutation, Age_at_onset, Sex, Disease_duration, Age, UPDRS)
# write.table(data, "/home/baptiste.criniere/Documents/Trainings/Linear regression/Simulation/Data/Exercice1.txt")
```


## Importation et data management
```{r echo=FALSE}
data <- read.table("/home/baptiste.criniere/Documents/Trainings/Linear regression/Simulation/Data/Exercice1.txt")
head(data)
str(data)
data <- data %>% 
  dplyr::mutate(Mutation = Mutation %>% factor) %>% 
  dplyr::mutate(Sex = Sex %>% factor)
```


## Exploration des données
```{r echo=TRUE}
data %>% 
  dplyr::select(-UPDRS) %>% 
  furniture::table1(Mutation, 
                    "Age at onset at onset" = Age_at_onset,
                     "Disease duration" = Disease_duration,
                    Age,
                    splitby =~ Sex,
                    test = TRUE,
                    output = "html")
```

## Analyse bi-variée relation entre nos covariables
### Age at onset & Mutation
```{r echo=TRUE}
aov <- data %>% anova_test(Age_at_onset ~ Mutation)
data %>% 
  ggplot(aes(x = Mutation, y = Age_at_onset, color = Mutation))+
  stat_boxplot(geom ='errorbar', width = 0.4, lwd = 0.85)+
  geom_boxplot(outlier.shape = NA, lwd = 0.85)+
  geom_jitter(alpha = 0.45, shape = 1, size = 1)+
  stat_summary(aes(fill = Mutation), fun = mean, geom = "point", shape = 23, size = 3, position = position_dodge(width=0.75)) +
  theme_classic()+
  scale_color_aaas()+
  scale_fill_aaas()+
  labs(subtitle = get_test_label(aov, detailed = TRUE),
       x = "",
       y = "Age at onset at onset (in years)")+
  theme(legend.position = "none",
        axis.line = element_line(size = 1, color = "black"),
        axis.text = element_text(face = "bold", size = 11),
        axis.title = element_text(face = "bold", size = 13))

## Modélisation
model1 <- lm(Age_at_onset ~ Mutation, data = data)
car::Anova(model1)
```

### Lien entre Disease duration & Mutation
```{r}
aov <- data %>% anova_test(Disease_duration ~ Mutation)
data %>% 
  ggplot(aes(x = Mutation, y = Disease_duration, color = Mutation))+
  stat_boxplot(geom ='errorbar', width = 0.4, lwd = 0.85)+
  geom_boxplot(outlier.shape = NA, lwd = 0.85)+
  geom_jitter(alpha = 0.45, shape = 1, size = 1)+
  stat_summary(aes(fill = Mutation), fun = mean, geom = "point", shape = 23, size = 3, position = position_dodge(width=0.75))+
  scale_color_aaas()+
  labs(subtitle = get_test_label(aov, detailed = TRUE),
       x = "",
       y = "Disease duration (in years)")+
  theme_classic()+
  theme(legend.position = "none",
        axis.line = element_line(size = 1, color = "black"),
        axis.text = element_text(face = "bold", size = 11),
        axis.title = element_text(face = "bold", size = 13))
```


### Age & Mutation
```{r}
aov <- data %>% anova_test(Age ~ Mutation)
data %>% 
  ggplot(aes(x = Mutation, y = Age, color = Mutation))+
  stat_boxplot(geom ='errorbar', width = 0.4, lwd = 0.85)+
  geom_boxplot(outlier.shape = NA, lwd = 0.85)+
  geom_jitter(alpha = 0.45, shape = 1, size = 1)+
  stat_summary(aes(fill = Mutation), fun = mean, geom = "point", shape = 23, size = 3, position = position_dodge(width=0.75))+
  scale_color_aaas()+
  labs(subtitle = get_test_label(aov, detailed = TRUE),
       x = "",
       y = "Age (in years)")+
  theme_classic()+
  theme(legend.position = "none",
        axis.line = element_line(size = 1, color = "black"),
        axis.text = element_text(face = "bold", size = 11),
        axis.title = element_text(face = "bold", size = 13))
```


### Age at onset & Disease duration
```{r}
data %>% 
  ggplot(aes(x = Age_at_onset, y = Disease_duration))+
  geom_jitter(alpha = 0.5, size = 2)+
  geom_smooth(method = "lm", se = FALSE, color = "darkred", size = 2)+
  stat_cor()+
  theme_classic()+
  labs(x = "Age at onset (in years)",
       y = "Disease duration (in years)")+
  theme(legend.position = "none",
        axis.line = element_line(size = 1, color = "black"),
        axis.text = element_text(face = "bold", size = 11),
        axis.title = element_text(face = "bold", size = 13))
```


### Age & Age at onset
```{r}
data %>% 
  ggplot(aes(x = Age_at_onset, y = Age))+
  geom_jitter(alpha = 0.5, size = 2)+
  geom_smooth(method = "lm", se = FALSE, color = "darkred", size = 2)+
  stat_cor()+
  theme_classic()+
  labs(x = "Age at onset (in years)",
       y = "Age (in years)")+
  theme(legend.position = "none",
        axis.line = element_line(size = 1, color = "black"),
        axis.text = element_text(face = "bold", size = 11),
        axis.title = element_text(face = "bold", size = 13))
```


### Age & Disease duration
```{r}
data %>% 
  ggplot(aes(x = Disease_duration, y = Age))+
  geom_jitter(alpha = 0.5, size = 2)+
  geom_smooth(method = "lm", se = FALSE, color = "darkred", size = 2)+
  stat_cor()+
  theme_classic()+
  labs(x = "Disease duration (in years)",
       y = "Age (in years)")+
  theme(legend.position = "none",
        axis.line = element_line(size = 1, color = "black"),
        axis.text = element_text(face = "bold", size = 11),
        axis.title = element_text(face = "bold", size = 13))
```

## Figure finale
```{r}
data %>% 
  dplyr::mutate(Age_discret = cut(Age, 
                    breaks = quantile(Age, probs = c(0, 0.25, 0.5, 0.75, 1)), 
                    labels = c("Q1", "Q2", "Q3", "Q4"),
                    include.lowest = TRUE)) %>% 
  dplyr::mutate(Mutation_bis = ifelse(Mutation %in% c("m/s", "f/s", "s/s"), "senescence", "non-senescence")) %>% 
  ggplot(aes(x = Disease_duration, y = UPDRS, color = Mutation_bis))+
  geom_point(alpha = 0.45)+
  geom_smooth(aes(group = Mutation_bis), method = "lm", se = FALSE, size = 1.5)+
  facet_wrap(~ Age_discret, nrow = 1)+
  theme_classic()+
  scale_color_aaas()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.line = element_line(color = "black"),
        axis.text = element_text(face = "bold", size = 11),
        axis.title = element_text(face = "bold", size = 13))+
  labs(x = "Disease duration (in years)",
       y = "UPDRS on")
```


## Modélisation
```{r}
data <- data %>% 
  dplyr::mutate(Mutation_bis = ifelse(Mutation %in% c("m/s", "f/s", "s/s"), "senescence", "non-senescence")) 
model2 <- lm(UPDRS ~ Disease_duration*Mutation_bis + Age + Sex, data = data)
Anova(model2)  
car::vif(model2)
```


## Figure finale
```{r}
interactions::interact_plot(model2,
                            pred = "Disease_duration",
                            modx = "Mutation_bis",
                            mod2 = Age)+
  theme_classic()+
  scale_color_aaas()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.line = element_line(color = "black"),
        axis.text = element_text(face = "bold", size = 8),
        axis.title = element_text(face = "bold", size = 10))+
  labs(x = "Disease Duration",
       y = "UPDRS on")
```

## Vérifications des hypothèses

### Résidus

```{r}
ggResidpanel::resid_panel(model)
```

### Colinéarité
```{r}
car::vif(model2)
```












